#!/usr/bin/env bash
set -euo pipefail

# SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" &>/dev/null && pwd -P)

GH_ASSOCIATED_PR_VERSION=0.1.0

msg() {
    echo >&2 -e "${1-}"
}

die() {
    local msg=$1
    local code=${2-1} # default exit status 1
    msg "$msg"
    exit "$code"
}

usage() {
    # shellcheck disable=SC1078
    die "gh-associated-pr version ${GH_ASSOCIATED_PR_VERSION}

Usage:
  gh-associated-pr [OPTIONS] [COMMIT_SHA]

Options:
  -h, --help            Show this help message
  --version             Show version
  -R, --repo OWNER/REPO Select another repository using the OWNER/REPO format
  --jq EXPRESSION       Filter JSON output using a jq expression (default: '.[].number')
  --graphql             Use GraphQL API instead of REST API
  --search              Use Search API (recommended for post-merge detection)
  --pr-list             Use PR list and check commits (most reliable for post-merge)
  --use-commit-date     Use commit date for If-Modified-Since header

Arguments:
  COMMIT_SHA            Commit SHA to find associated PRs (default: HEAD)
" "$1"
}

parse_params() {
    INPUT_BYPASS_OPTIONS=()
    COMMIT_SHA=""
    REPO=""
    JQ_QUERY=".[].number"
    USE_GRAPHQL=false
    USE_SEARCH=false
    USE_PR_LIST=false
    USE_COMMIT_DATE=false

    while :; do
        case "${1-}" in
        --version )
            echo "gh-associated-pr version ${GH_ASSOCIATED_PR_VERSION}"
            exit 0
            ;;
        --help| -h )
            usage 0
            ;;
        --repo | -R )
            REPO="${2-}"
            shift
            ;;
        --jq )
            JQ_QUERY="${2-}"
            shift
            ;;
        --graphql )
            USE_GRAPHQL=true
            ;;
        --search )
            USE_SEARCH=true
            ;;
        --pr-list )
            USE_PR_LIST=true
            ;;
        --use-commit-date )
            USE_COMMIT_DATE=true
            ;;
        -- )
            shift
            INPUT_BYPASS_OPTIONS=("$@")
            break ;;
        --*| -* )
            echo "${1:-} is invalid option."
            usage 1
            ;;
        ?* )
            COMMIT_SHA="${1-}"
            ;;
        *) 
            break ;;
        esac
        shift
    done
    return 0
}

parse_params "$@"

TRAILING_OPTIONS=()
if [ "${#INPUT_BYPASS_OPTIONS[@]}" != 0 ]; then
    TRAILING_OPTIONS+=("${INPUT_BYPASS_OPTIONS[@]}")
fi

get_if_modified_since_from_commit() {
    local commit_sha=$1
    local repo=$2
    
    # Get commit information
    local commit_date
    commit_date=$(GH_PAGER="cat" gh api "/repos/${repo}/commits/${commit_sha}" \
        --jq '.commit.author.date' 2>/dev/null)
    
    if [ -z "$commit_date" ]; then
        # Fallback to default if commit date cannot be retrieved
        echo "Thu, 01 Jan 1970 00:00:00 GMT"
        return
    fi
    
    # Convert to timestamp and subtract 60 seconds
    local timestamp
    if date --version >/dev/null 2>&1; then
        # GNU date
        timestamp=$(date -d "$commit_date" +%s 2>/dev/null || echo "0")
    else
        # BSD date (macOS)
        timestamp=$(date -j -f "%Y-%m-%dT%H:%M:%SZ" "$commit_date" +%s 2>/dev/null || echo "0")
    fi
    
    if [ "$timestamp" -eq 0 ]; then
        echo "Thu, 01 Jan 1970 00:00:00 GMT"
        return
    fi
    
    # Subtract 60 seconds
    timestamp=$((timestamp - 60))
    
    # Convert back to HTTP date format
    if date --version >/dev/null 2>&1; then
        # GNU date
        date -u -d "@${timestamp}" "+%a, %d %b %Y %H:%M:%S GMT"
    else
        # BSD date (macOS)
        date -u -r "${timestamp}" "+%a, %d %b %Y %H:%M:%S GMT"
    fi
}

get_associated_prs_rest() {
    local commit_sha=$1
    local repo=$2
    local jq_query=$3
    local use_commit_date=$4
    
    local if_modified_since="Thu, 01 Jan 1970 00:00:00 GMT"
    if [ "$use_commit_date" = true ]; then
        if_modified_since=$(get_if_modified_since_from_commit "$commit_sha" "$repo")
        msg "Using If-Modified-Since: ${if_modified_since}"
    fi
    
    # Fetch pull requests associated with the commit using GitHub REST API
    # Set GH_PAGER to cat to prevent interactive pager
    GH_PAGER="cat" gh api "/repos/${repo}/commits/${commit_sha}/pulls" \
        -H "If-Modified-Since: ${if_modified_since}" \
        -H "Cache-Control: no-cache" \
        --jq "$jq_query" \
        "${TRAILING_OPTIONS[@]}"
}

get_associated_prs_graphql() {
    local commit_sha=$1
    local repo=$2
    local jq_query=$3
    local use_commit_date=$4
    
    local if_modified_since="Thu, 01 Jan 1970 00:00:00 GMT"
    if [ "$use_commit_date" = true ]; then
        if_modified_since=$(get_if_modified_since_from_commit "$commit_sha" "$repo")
        msg "Using If-Modified-Since: ${if_modified_since}"
    fi
    
    # Split owner and repo name
    local owner="${repo%%/*}"
    local name="${repo##*/}"
    
    # GraphQL query to fetch pull requests associated with a commit
    local query
    read -r -d '' query << 'EOF' || true
query($owner: String!, $name: String!, $oid: GitObjectID!) {
  repository(owner: $owner, name: $name) {
    object(oid: $oid) {
      ... on Commit {
        associatedPullRequests(first: 100) {
          nodes {
            number
            title
            url
            state
            author {
              login
            }
            mergedAt
            closedAt
            createdAt
          }
        }
      }
    }
  }
}
EOF
    
    # Execute GraphQL query and extract PR data
    # Set GH_PAGER to cat to prevent interactive pager
    GH_PAGER="cat" gh api graphql \
        -H "If-Modified-Since: ${if_modified_since}" \
        -H "Cache-Control: no-cache" \
        -f query="$query" \
        -f owner="$owner" \
        -f name="$name" \
        -f oid="$commit_sha" \
        --jq ".data.repository.object.associatedPullRequests.nodes | $jq_query" \
        "${TRAILING_OPTIONS[@]}"
}

get_associated_prs_search() {
    local commit_sha=$1
    local repo=$2
    local jq_query=$3
    
    # Search for pull requests containing the commit SHA
    # gh search command often has fresher data than the commits API
    GH_PAGER="cat" gh search prs \
        --repo "$repo" \
        --json number,title,url,state,author,closedAt,createdAt \
        --jq ". | $jq_query" \
        "$commit_sha"
}

get_associated_prs_pr_list() {
    local commit_sha=$1
    local repo=$2
    local jq_query=$3
    
    # Get all merged PRs and check if they contain the commit
    # This is more reliable for post-merge scenarios
    GH_PAGER="cat" gh pr list \
        --repo "$repo" \
        --state merged \
        --limit 100 \
        --json number,mergeCommit \
        --jq "map(select(.mergeCommit.oid == \"$commit_sha\")) | $jq_query"
}

get_associated_prs() {
    local commit_sha=$1
    local repo=$2
    local jq_query=$3
    local use_graphql=$4
    local use_search=$5
    local use_pr_list=$6
    local use_commit_date=$7
    
    # Use current commit if not specified
    if [ -z "$commit_sha" ]; then
        commit_sha=$(git rev-parse HEAD)
    fi
    
    # Get repository information if not specified
    if [ -z "$repo" ]; then
        repo=$(gh repo view --json nameWithOwner -q .nameWithOwner)
    fi
    
    if [ -z "$repo" ]; then
        die "Failed to get repository information"
    fi
    
    # Call appropriate API implementation
    if [ "$use_pr_list" = true ]; then
        get_associated_prs_pr_list "$commit_sha" "$repo" "$jq_query"
    elif [ "$use_search" = true ]; then
        get_associated_prs_search "$commit_sha" "$repo" "$jq_query"
    elif [ "$use_graphql" = true ]; then
        get_associated_prs_graphql "$commit_sha" "$repo" "$jq_query" "$use_commit_date"
    else
        get_associated_prs_rest "$commit_sha" "$repo" "$jq_query" "$use_commit_date"
    fi
}

main() {
    get_associated_prs "$COMMIT_SHA" "$REPO" "$JQ_QUERY" "$USE_GRAPHQL" "$USE_SEARCH" "$USE_PR_LIST" "$USE_COMMIT_DATE"
}

main
