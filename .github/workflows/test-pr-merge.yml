name: Test PR Merge

on:
  workflow_dispatch:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'

env:
  GH_TOKEN: ${{ github.token }}

permissions:
  contents: write
  pull-requests: write

jobs:
  create-and-merge-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create test file
        id: create-commit
        run: |
          TIMESTAMP=$(date +%s)
          echo "Test commit at ${TIMESTAMP}" >> test-commit.txt
          git add test-commit.txt

      - uses: actions/create-github-app-token@v2
        id: app-token
        if: steps.check-diff.outputs.diff == '1'
        with:
          app-id: ${{ secrets.MY_ACTIONS_APP_ID }}
          private-key: ${{ secrets.MY_ACTIONS_APP_PRIVATE_KEY }}

      - name: Commit changes and create PR
        uses: suzuki-shunsuke/commit-action@f28421acc277a6d6a9c1f94ea449076ad77dba67 # v0.1.0
        with:
          commit_message: "Test commit for PR merge"
          branch: ci/test-pr-merge-${{ github.run_id }}
          parent_branch: main
          github_token: ${{ steps.app-token.outputs.token }}
          files: |
            test-commit.txt

      - name: Create pull request
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        id: create-pr
        run: |
          gh pr create \
            --base test-merge-base \
            --head "ci/test-pr-merge-${{ github.run_id }}" \
            --title "Test PR for merge" \
            --body "This PR is created automatically for testing gh-associated-pr after merge." \
          || :
          PR_NUMBER=$(gh pr list --head "ci/test-pr-merge-${{ github.run_id }}" --json number --jq '.[0].number')
          echo "PR_NUMBER=${PR_NUMBER}" >> "${GITHUB_OUTPUT}"

      - name: Wait for checks
        run: |
          # Wait a bit for CI to start
          sleep 10

          # Wait for checks to complete (with timeout)
          TIMEOUT=300
          ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            STATUS=$(gh pr view ${{ steps.create-pr.outputs.PR_NUMBER }} --json statusCheckRollup --jq '.statusCheckRollup | length')
            if [ "$STATUS" = "0" ] || gh pr checks ${{ steps.create-pr.outputs.PR_NUMBER }} --watch --interval 10; then
              echo "Checks completed"
              break
            fi
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done

      - name: Merge Pull Request
        run: |
          gh pr merge ${{ steps.create-pr.outputs.PR_NUMBER }} \
            --squash \
            --auto \
            --delete-branch || \
          gh pr merge ${{ steps.create-pr.outputs.PR_NUMBER }} \
            --squash \
            --delete-branch

      - name: Wait for merge to complete
        run: |
          sleep 1

      - name: Test gh-associated-pr after merge
        run: |
          # Fetch latest changes
          git fetch origin test-merge-base
          git checkout test-merge-base
          git pull origin test-merge-base

          # Install extension
          make install

          # Get merge commit SHA
          MERGE_SHA=$(gh pr view ${{ steps.create-pr.outputs.PR_NUMBER }} --json mergeCommit --jq .mergeCommit.oid)
          echo "Testing with merge commit: ${MERGE_SHA}"

          # Test REST API
          echo "Testing REST API..."
          PR_NUMBER=$(gh associated-pr "${MERGE_SHA}" | head -n 1)
          echo "Found PR: ${PR_NUMBER}"

          if [ "${PR_NUMBER}" != "${{ steps.create-pr.outputs.PR_NUMBER }}" ]; then
            echo "ERROR: Expected PR ${{ steps.create-pr.outputs.PR_NUMBER }}, got ${PR_NUMBER}"
            exit 1
          fi

          # Test GraphQL API
          echo "Testing GraphQL API..."
          PR_NUMBER=$(gh associated-pr --graphql "${MERGE_SHA}" | head -n 1)
          echo "Found PR: ${PR_NUMBER}"

          if [ "${PR_NUMBER}" != "${{ steps.create-pr.outputs.PR_NUMBER }}" ]; then
            echo "ERROR: Expected PR ${{ steps.create-pr.outputs.PR_NUMBER }}, got ${PR_NUMBER}"
            exit 1
          fi

          # Test Search API
          echo "Testing Search API..."
          PR_NUMBER=$(gh associated-pr --search "${MERGE_SHA}" | head -n 1)
          echo "Found PR: ${PR_NUMBER}"

          if [ "${PR_NUMBER}" != "${{ steps.create-pr.outputs.PR_NUMBER }}" ]; then
            echo "ERROR: Expected PR ${{ steps.create-pr.outputs.PR_NUMBER }}, got ${PR_NUMBER}"
            exit 1
          fi

          # Test PR List API
          echo "Testing PR List API..."
          PR_NUMBER=$(gh associated-pr --pr-list "${MERGE_SHA}" | head -n 1)
          echo "Found PR: ${PR_NUMBER}"

          if [ "${PR_NUMBER}" != "${{ steps.create-pr.outputs.PR_NUMBER }}" ]; then
            echo "ERROR: Expected PR ${{ steps.create-pr.outputs.PR_NUMBER }}, got ${PR_NUMBER}"
            exit 1
          fi

          echo "All tests passed!"
